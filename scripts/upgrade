#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# SPECIAL HANDLING OF PREVIOUS BETA VERSIONS
#=================================================

# Previous beta versions of prosody app were built from source.
# We need to uninstall them properly before installing debian's package.
current_version=$(yunohost app info prosody | grep version | awk '{print $2}')
echo "${current_version}" | grep -qE "0.12.4~ynh1([0-9]{2})" || ynh_die "Sorry but you cannot upgrade from version ${current_version} because it was built from source and new version must be installed from Debian packages.
You must uninstall and reinstall the app.
Don't worry, no data will be lost."

#=================================================
# ADD CONFIGURATION FILES
#=================================================

# Add config files for prosody and nginx
ynh_script_progression "Configuring prosody and nginx..."
_configure_prosody

yunohost service add $app --log="/var/log/$app/$app.log" --needs_exposed_ports $port_client $port_client2 $port_server

#=================================================
# RESTART SYSTEMD SERVICE
#=================================================

ynh_script_progression "Restarting $app's systemd service..."
ynh_systemctl --service=$app --action="restart"

ynh_script_progression "Reloading nginx..."
ynh_systemctl --service="nginx" --action="reload"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
